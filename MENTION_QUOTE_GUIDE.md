# @提及和引用功能使用指南

本文档详细说明如何使用 AI 群聊助手的 @提及和引用回复功能。

## @提及功能

### 基本用法

在消息中使用 `@` 符号可以直接召唤 AI 机器人，有三种使用方式：

#### 1. @特定机器人

格式：`@机器人名称 你的问题`

示例：
```
@技术助手 这段代码有什么问题？
@客服小助手 如何重置密码？
```

特点：
- 只会触发被 @ 的机器人
- 即使消息不包含该机器人的触发关键词也会触发
- 适合需要特定机器人回答的场景

#### 2. @所有机器人

格式：`@all 你的问题`

示例：
```
@all 大家怎么看这个技术方案？
@all 谁能帮我解答这个问题？
```

特点：
- 会触发所有活跃的 AI 机器人
- 每个机器人都会根据自己的人格给出回复
- 适合需要多个视角或意见的场景

#### 3. 关键词触发（传统方式）

如果消息中没有 @，系统会检查是否包含机器人配置的触发关键词。

示例：
```
# 假设"技术助手"的触发关键词包含"代码"
这段代码怎么优化？
# "技术助手"会自动触发
```

### @提及的自动补全

输入框支持 @ 自动补全功能：

1. 输入 `@` 符号
2. 系统会显示可用的机器人列表
3. 可以继续输入筛选机器人名称
4. 点击列表中的机器人名称自动插入

补全列表包含：
- `@all` - 所有机器人
- `@机器人1` - 具体机器人名称
- `@机器人2` - 更多机器人...

## 引用回复功能

### 如何引用消息

1. **鼠标悬停**：将鼠标移到任何消息上
2. **点击引用按钮**：点击出现的回复图标（↩️）
3. **编写回复**：在输入框顶部会显示被引用的消息预览
4. **发送消息**：输入你的回复并发送

### 引用消息的显示

被引用的消息会显示在新消息的顶部：

```
┌─────────────────────────────┐
│ 回复 技术助手                │
│ "这个问题可以用..."          │
├─────────────────────────────┤
│ 你的回复内容                │
└─────────────────────────────┘
```

### 取消引用

如果不想引用了，可以：
- 点击引用预览框右上角的 × 按钮
- 发送消息后会自动清除引用

### AI 如何理解引用

当你引用消息回复时：
1. AI 会收到被引用消息的完整内容
2. 你的回复会标注为"回复某某的消息"
3. AI 能够更好地理解上下文关系

示例：
```
用户消息：[引用 技术助手的回复] 能详细解释第二点吗？

AI 收到的内容：
[回复 技术助手: "...原始消息内容..."]
能详细解释第二点吗？
```

## 上下文管理

### 上下文限制

为了控制 token 使用和提高响应速度，系统限制了上下文长度：

- **默认上下文**：最近 5 条消息
- **引用消息**：会额外添加到上下文中（不占用5条限制）
- **消息类型**：只包含用户消息和 AI 回复，不包含 RSS 消息

### 上下文构建逻辑

```
上下文 = [
  被引用的消息（如果有），
  最近5条对话消息（用户和AI）,
  当前消息
]
```

这样设计的优点：
1. **控制成本**：限制 token 数量
2. **提高速度**：减少处理时间
3. **保持相关性**：只保留最近的对话
4. **引用增强**：通过引用可以主动添加远期消息到上下文

## 使用场景

### 场景 1：多机器人协作

```
用户：@all 这个产品功能应该怎么设计？

产品经理机器人：从用户需求角度来看...
技术助手机器人：技术实现上需要考虑...
运营助手机器人：运营推广方面建议...
```

### 场景 2：深入讨论

```
技术助手：这个方案有三个优点...

用户：[引用上面的回复] 能详细说说第一个优点吗？

技术助手：[理解了上下文] 第一个优点是...
```

### 场景 3：指定回答者

```
用户：@客服小助手 我的订单号123456的进度如何？
# 只有客服机器人回复，避免其他机器人干扰
```

### 场景 4：长对话追溯

当对话很长时，通过引用可以让 AI 看到之前的消息：

```
[50条消息之前]
用户：我们讨论过使用 Redis 做缓存

[现在]
用户：[引用50条消息之前的那条] @技术助手 当时讨论的 Redis 方案，能再详细说说吗？
# AI 能看到被引用的消息，即使它不在最近5条内
```

## 最佳实践

### 1. 合理使用 @all

**推荐场景**：
- 需要多个角度的意见
- 头脑风暴
- 问题不确定由谁回答

**不推荐场景**：
- 明确知道该问谁
- 需要专业回答
- 私密或敏感问题

### 2. 善用引用功能

**推荐场景**：
- 对某条回复进行追问
- 讨论之前提到的内容
- 需要明确上下文关系

**技巧**：
- 引用时简化你的提问
- 不需要重复被引用消息的内容
- 引用消息本身就是上下文

### 3. 理解上下文限制

**建议**：
- 重要的历史信息通过引用带入
- 不要期望 AI 记住 5 条以外的消息
- 如需讨论更早的内容，使用引用功能

### 4. @提及的使用时机

**需要 @**：
- 跳过关键词检测
- 确保特定机器人回复
- 需要所有机器人参与

**不需要 @**：
- 日常对话（触发关键词即可）
- 自然交流场景
- 不确定该问谁时先用关键词

## 技术细节

### @提及的匹配规则

```typescript
// @all 匹配
/@all\b/i

// @机器人名称匹配
/@机器人名称\b/i
```

注意：
- 匹配不区分大小写
- 使用单词边界，确保精确匹配
- `@all` 是特殊关键词，总是匹配所有机器人

### 引用消息的存储

```sql
messages 表结构：
- id: UUID
- content: TEXT
- quoted_message_id: UUID (可为空)
- ...其他字段
```

### API 参数

发送消息时的 JSON 格式：

```json
{
  "content": "消息内容",
  "quoted_message_id": "被引用消息的UUID" // 可选
}
```

## 常见问题

### Q: @提及和触发关键词可以同时使用吗？

A: 可以，但 @ 提及优先级更高。如果消息中有 @，系统会忽略关键词触发，只看 @ 的内容。

### Q: 可以同时 @ 多个机器人吗？

A: 可以，例如 `@机器人1 @机器人2 问题`，两个机器人都会响应。

### Q: 引用功能是否会增加 token 消耗？

A: 会略微增加。被引用的消息会额外添加到上下文中，但只增加一条消息的 token。

### Q: AI 的回复可以被引用吗？

A: 可以，任何消息（用户、AI、RSS）都可以被引用。

### Q: @all 会触发不活跃的机器人吗？

A: 不会，只会触发 `is_active = true` 的机器人。

### Q: 上下文5条是如何计数的？

A: 只计算用户消息和 AI 回复，按时间倒序取最近 5 条。RSS 消息不计入。

## 更新日志

- **2024-01-22**: 实现 @提及、引用回复和上下文控制功能
- 支持 `@机器人名称` 和 `@all`
- 支持引用任何历史消息
- 上下文限制为最近 5 条消息

## 反馈与建议

如果您有任何使用问题或功能建议，欢迎在 GitHub Issues 中提出。
